{% extends "exercise_base.html" %}

{% block title %}{{ block.super }}XSS via Query Parameters{% endblock %}

{% block header %}
    <h1>XSS via Query Parameters</h1>
{% endblock %}

{% block content %}
<p>We have all heard that it is very dangerous to blindly use user input
in our pages. How easy is it to exploit?</p>

<p>In this exercise you must add a new <code>&lt;img&gt;</code> element to the DOM. The
source for the image needs to be <code>http://test/image.jpg</code> exactly.
Bonus points if you figure out how to hide the image from the end user.</p>

<div id="result"></div>

<div class="hidden hints panel">
    <p>This page has not yet been hacked. Some helpful hints:</p>
    <ul>
        <li>Look at the HTML and compare it to the query params</li>
        <li>Your JavaScript must be escaped</li>
        <li><code>document.createElement</code>, <code>.setAttribute</code> and <code>document.body.appendChild</code> are your friends.</li>
        <li>Remember to terminate the statement you are trying to hijack</li>
    </ul>
    <a class="tiny button" id="show_solution">show solution</a>
</div>
<div class="solution panel">
    <h4>Solution</h4>
    <p>The correct URL looks like:</p>
    <p><a href="/cross-site-scripting/query-params?qs=%22%3Bvar%20i%3Ddocument.createElement%28%27img%27%29%3Bi.src%3D%27http%3A//test/image.jpg%27%3Bdocument.body.appendChild%28i%29%3B%22">click here</a></p>
    <p>This querystring was created using interactive Python:</p>
    <p><code>
        s = '''";var i=document.createElement('img');''' + \<br>
        '''i.src='http://test/image.jpg';''' + \<br>
        '''i.setAttribute('display', 'none');''' + \<br>
        '''document.body.appendChild(i);"'''<br>
        urllib.quote(s)
        </code>
    </p>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script type="text/javascript">
    var myvar = "{{qs|safe}}";

    function find_hack_image() {
        for (var x=0; x<document.images.length; x++) {
            if (document.images[x].src == 'http://test/image.jpg')
                return document.images[x];
        }
        return null;
    }

    var result = '';
    var img = find_hack_image();
    if (img && img.style.display == 'none') {
        result = '<div class="answer panel"><p><strong>Sweeeeeet!</strong> You get bonus points, brown noser.</p></div>';
    } else if (img) {
        result = '<div class="answer panel"><p><strong>Success!</strong> You have added your own ' +
            'img to my page. For bonus points you should try to hide ' +
            'it from the user.</p></div>';
    } else if (myvar != 'awesome') {
        $('.hints').removeClass('hidden');
    }
    document.getElementById("result").innerHTML = result;
</script>
{% endblock %}

{% block extra_topnav %}
<li><a href="{% url 'xss-form' %}">Prev</a></li>
<li><a href="{% url 'direct-object-references' %}">Next</a></li>
{% endblock %}

{% block extra_botnav %}
<li><a href="{% url 'xss-form' %}">Prev</a></li>
<li><a href="{% url 'direct-object-references' %}">Next</a></li>
{% endblock %}
