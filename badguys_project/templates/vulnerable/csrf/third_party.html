{% extends "exercise_base.html" %}

{% block title %}{{ block.super }}CSRF from a Third-Party Site{% endblock %}

{% block header %}
    <h1>CSRF from a Third-Party Site</h1>
{% endblock %}

{% block content %}

<p>As an evil genius you are interested in tricking unsuspecting users into
giving you gift cards.</p>

<p>Open up this template (<code>badguys_project/templates/vulnerable/csrf/third_party.html</code>)
in your editor and create a form that will POST data to the
<a href="{% url 'csrf-gift-card' %}">gift card</a> form.</p>

<ul>
    <li>Your email address is <code>evil@evil.com</code></li>
    <li>You want $100 giftcards (the field expects an integer)</li>
    <li>All inputs (except the submit) should be hidden</li>
    <li>Your submit button should say <code>View Photos</code> because that looks innocent</li>
</ul>

<p>Helpful hints:</p>

<ul>
    <li>Don't remove the Javascript or you may never finish.</li>
</ul>


<!-- put your form here

<form><input></form>

-->

{% endblock %}


{% block extra_head %}
<script src="{{STATIC_URL}}js/vendor/jquery.js"></script>
<script type="text/javascript">
$(function() {
    function checkValue($form, selector, name, expected_value) {
        var input = $form.find(selector)[0 ];
        if (!input) {
            alert('You seem to be missing a required input.');
            return false;
        }

        if ($(input).attr('value').toLowerCase() !== expected_value.toLowerCase()) {
            alert('You seem to be using the wrong value for ' + name + '.');
            return false;
        }

        return true;
    }

    var expected_path = '/danger/vulnerable/csrf-image';
    $(document).on('submit', 'form', function(e) {
        var $form = $(this);
        if ($form.attr('action').indexOf(expected_path) === -1) {
            alert('Check your form action. It appears to be incorrect.');
            return false;
        }
        if ($form.attr('method').toUpperCase() != 'POST') {
            alert('Check your form method. You should be POSTing.');
            return false;
        }

        // inputs should be either hidden or submit
        var inputs = $form.find('input').toArray();
        for (var i in inputs) {
            var $input = $(inputs[i ]);
            switch ($input.attr('type').toLowerCase()) {
                case 'hidden':
                case 'submit':
                    break; // all good
                default:
                    alert('You appear to have inputs that are not hidden.');
                    return false;
            }
        }

        if (!checkValue($form, 'input[type="submit" ]', 'submit', 'View Photos')) {
            return false;
        }
        if (!checkValue($form, 'input[name="email" ]', 'email', 'evil@evil.com')) {
            return false;
        }
        if (!checkValue($form, 'input[name="amount" ]', 'amount', '100')) {
            return false;
        }

        alert('Congrats! You did it!');
        return false;
    });
});
</script>
{% endblock %}

{% block extra_topnav %}
<li><a href="{% url 'csrf-image' %}">Prev</a></li>
<li><a href="{% url 'components' %}">Next</a></li>
{% endblock %}

{% block extra_botnav %}
<li><a href="{% url 'csrf-image' %}">Prev</a></li>
<li><a href="{% url 'components' %}">Next</a></li>
{% endblock %}