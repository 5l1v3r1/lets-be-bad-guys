{% extends "exercise_base.html" %}

{% block title %}{{ block.super }}CSRF from a Third-Party Site{% endblock %}

{% block header %}
    <h1>CSRF from a Third-Party Site</h1>
{% endblock %}

{% block content %}

<p>As an evil genius you are interested in tricking unsuspecting users into
giving you gift cards.</p>

<p>Open up this template (<code>badguys_project/templates/vulnerable/csrf/third_party.html</code>)
in your editor and create a form that will POST data to the
<a href="{% url 'csrf-gift-card' %}">gift card</a> form.</p>

<ul>
    <li>Your email address is <code>evil@evil.com</code></li>
    <li>You want $100 giftcards (the field expects an integer)</li>
    <li>All inputs (except the submit) should be hidden</li>
    <li>Your submit button should say <code>View Photos</code> because that looks innocent</li>
    <li><strong>Don't remove the Javascript or you may never finish.</strong></li>
</ul>


<!-- put your form here

<form><input></form>

-->

{% endblock %}


{% block extra_head %}
<script src="{{STATIC_URL}}js/vendor/jquery.js"></script>
<script type="text/javascript">
$(function() {
    function die(msg) { alert(msg); return false; }

    function checkValue($form, selector, name, expected_value) {
        var input = $form.find(selector)[0];
        if (!input) { return die('You seem to be missing a required input.'); }
        if ($(input).attr('value').toLowerCase() !== expected_value.toLowerCase()) {
            return die('You seem to be using the wrong value for ' + name + '.');
        }
        return true;
    }

    var allowed_actions = ['http://localhost:8000/csrf/gift-card', 'http://127.0.0.1:8000/csrf/gift-card'];
    $(document).on('submit', 'form', function(e) {
        var $form = $(this);
        if (!$form.attr('action') || allowed_actions.indexOf($form.attr('action')) === -1) {
            return die('Check your form action. It appears to be incorrect. You want the full URL to the giftcard form!');
        }
        if (!$form.attr('method') || $form.attr('method').toUpperCase() != 'POST') {
            return die('Check your form method. You should be POSTing.');
        }

        // inputs should be either hidden or submit
        var inputs = $form.find('input').toArray();
        for (var i in inputs) {
            var type = $(inputs[i]).attr('type') || '';
            switch (type.toLowerCase()) {
                case 'hidden':
                case 'submit':
                    break; // all good
                default:
                    return die('You appear to have inputs that are not hidden.');
            }
        }

        if (!checkValue($form, 'input[type="submit"]', 'submit', 'View Photos')) {
            return false;
        }
        if (!checkValue($form, 'input[name="email"]', 'email', 'evil@evil.com')) {
            return false;
        }
        if (!checkValue($form, 'input[name="amount"]', 'amount', '100')) {
            return false;
        }

        alert('Congrats! You did it!');
        return false;
    });
});
</script>
{% endblock %}

{% block extra_topnav %}
<li><a href="{% url 'csrf-image' %}">Prev</a></li>
<li><a href="{% url 'components' %}">Next</a></li>
{% endblock %}

{% block extra_botnav %}
<li><a href="{% url 'csrf-image' %}">Prev</a></li>
<li><a href="{% url 'components' %}">Next</a></li>
{% endblock %}
